// Prisma Schema for Jimo Market
// Development: SQLite
// Production: PostgreSQL (Railway)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User model with Hedera DID integration
// DID private key is stored client-side, not on server
model User {
  id                String   @id @default(uuid())
  hederaAccountId   String   @unique // 0.0.xxxxx
  did               String?  @unique // did:hedera:testnet:xxx (created after DID registration)
  didPublicKey      String?  // DID public key (received from client)
  didRegistered     Boolean  @default(false) // Whether DID Document is on HCS
  userName          String?
  region            String?
  avatarUrl         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastLoginAt       DateTime @default(now())
  
  // Relations
  agents            Agent[]
}

// Agent model for marketplace AI agents
 model Agent {
  id          String   @id @default(uuid())
  userId      String
  type        String   // "give" (seller) or "want" (buyer)
  name        String
  description String?
  status      String   @default("active") // "active" | "paused"
  channelId   String?  // ElizaOS channel ID for messaging
  elizaAgentId String? @unique // Persisted ElizaOS agent runtime ID for restoration
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // ERC-8004 Blockchain Registration
  erc8004AgentId    Int?     @unique // On-chain Agent ID (ERC-721 tokenId)
  blockchainTxId    String?  // Hedera transaction ID for registration

  // ERC-8004 Off-chain Data (cached from blockchain for performance)
  tokenURI          String?  // IPFS URI for agent metadata
  ownerDid          String?  // Owner's DID (stored on-chain and cached here)

  // Reputation (for Agent Discovery)
  reputationScore      Int      @default(1000)  // Default 1000 points
  totalTransactions    Int      @default(0)      // Total number of transactions

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages    Message[]

  @@index([userId])
  @@index([type])
  @@index([reputationScore])
}

// Message model for agent conversation history
model Message {
  id          String   @id @default(uuid())
  agentId     String
  role        String   // "user" | "agent"
  content     String   // Message content
  createdAt   DateTime @default(now())

  // Relations
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([createdAt])
}

// Marketplace Listing model
model Listing {
  id              String   @id @default(uuid())
  listingId       String   @unique // Blockchain listing ID
  sellerAgentId   Int      // ERC-8004 Agent ID
  title           String
  description     String
  basePrice       Float    // HBAR
  expectedPrice   Float    // HBAR
  status          String   @default("OPEN") // OPEN, RESERVED, COMPLETED, CANCELLED
  transactionId   String   // Hedera transaction ID
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  inquiries       Inquiry[]

  @@index([listingId])
  @@index([status])
}

// Marketplace Inquiry model
model Inquiry {
  id              String   @id @default(uuid())
  inquiryId       String   @unique // Blockchain inquiry ID
  listingId       String   // Target listing ID (blockchain)
  buyerAgentId    Int      // ERC-8004 Agent ID
  offerPrice      Float    // HBAR
  message         String
  status          String   @default("PENDING") // PENDING, ACCEPTED
  transactionId   String   // Hedera transaction ID
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  listing         Listing  @relation(fields: [listingId], references: [listingId])

  @@index([inquiryId])
  @@index([listingId])
  @@index([status])
}

// Buy Request model - Buyer posts what they want to buy
model BuyRequest {
  id              String   @id @default(uuid())
  buyerAgentId    Int      // ERC-8004 Agent ID
  title           String   // What they want (e.g., "Blue chair")
  description     String   // Detailed requirements
  minPrice        Float    // Minimum budget in HBAR
  maxPrice        Float    // Maximum budget in HBAR
  category        String?  // Optional category
  status          String   @default("OPEN") // OPEN, MATCHED, CLOSED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Search progress fields (backend-driven)
  searchStep      String   @default("idle") // idle, searching, found, verifying, verified, contacting, contacted, negotiating, complete, error, no_results
  searchMessage   String?  // Current status message
  matchedListingId Int?    // The listing that was matched
  sellerAgentId   Int?     // The seller agent ID
  a2aEndpoint     String?  // Resolved A2A endpoint
  searchError     String?  // Error message if search failed
  negotiationRoomId String? // Link to NegotiationRoom

  @@index([buyerAgentId])
  @@index([status])
  @@index([category])
}

// Negotiation Room - Created when Listing is created, used for A2A communication
model NegotiationRoom {
  id              String   @id @default(uuid())
  listingId       String   @unique // One room per listing (blockchain listing ID)
  sellerAgentId   Int      // ERC-8004 Agent ID of seller
  buyerAgentId    Int?     // ERC-8004 Agent ID of buyer (set when matched)
  sellerA2AEndpoint String // Seller's A2A endpoint
  buyerA2AEndpoint  String? // Buyer's A2A endpoint (set when matched)
  status          String   @default("WAITING") // WAITING, ACTIVE, COMPLETED, CANCELLED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  messages        NegotiationMessage[]

  @@index([listingId])
  @@index([sellerAgentId])
  @@index([buyerAgentId])
  @@index([status])
}

// Negotiation Message - A2A communication log
model NegotiationMessage {
  id              String   @id @default(uuid())
  roomId          String
  room            NegotiationRoom @relation(fields: [roomId], references: [id])
  sender          String   // "seller" or "buyer"
  senderAgentId   Int      // ERC-8004 Agent ID
  content         String   // Message content
  messageType     String   @default("text") // text, offer, counter_offer, accept, reject
  metadata        String?  // JSON metadata (e.g., price offers)
  createdAt       DateTime @default(now())

  @@index([roomId])
  @@index([createdAt])
}
